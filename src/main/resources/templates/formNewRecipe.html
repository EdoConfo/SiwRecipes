<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuova Ricetta - SiwRecipes</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <header th:replace="~{fragments/base :: header}"></header>

    <main class="container" style="max-width: 95%; margin: 2rem auto; padding: 0 1rem;">
        
        <form th:action="@{/recipes}" method="POST" th:object="${recipe}" enctype="multipart/form-data">
            
            <div th:if="${#fields.hasGlobalErrors()}" class="error-message" style="margin-bottom: 2rem; background-color: #ffebee; color: #c62828; padding: 1rem; border-radius: 5px; border: 1px solid #ef9a9a;">
                <p th:each="err : ${#fields.globalErrors()}" th:text="${err}" style="margin: 0;">Errore Globale</p>
            </div>

            <div class="recipe-top-section">
                <!-- Immagine Ricetta (Sinistra) -->
                <div class="recipe-image-container">
                    <div id="imagePreview" style="background-color: #eee; height: 300px; display: flex; align-items: center; justify-content: center; border-radius: 10px; color: #aaa; cursor: pointer; overflow: hidden; position: relative; border: 2px dashed #ccc; transition: all 0.3s ease;" onclick="document.getElementById('image').click()" onmouseover="this.style.borderColor='#e67e22'; this.style.color='#e67e22'" onmouseout="this.style.borderColor='#ccc'; this.style.color='#aaa'">
                        <div id="placeholderContent" style="text-align: center;">
                            <i class="fas fa-camera fa-3x" id="uploadIcon" style="margin-bottom: 10px;"></i>
                            <div style="font-size: 0.9rem;">Clicca per caricare un'immagine</div>
                        </div>
                        <img id="previewImg" src="#" alt="Anteprima" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <input type="file" id="image" name="file" accept="image/*" style="display: none;" onchange="previewImage(this)">
                    <span th:if="${#fields.hasErrors('image')}" th:errors="*{image}" class="error-message" style="color: #e74c3c; font-size: 0.9rem; display: block; margin-top: 5px; text-align: center;"></span>
                </div>

                <!-- Intestazione Ricetta (Destra) -->
                <div class="recipe-info-container">
                    <!-- Titolo -->
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <input type="text" id="title" th:field="*{title}" placeholder="Titolo della Ricetta" required style="font-size: 2.5rem; color: #2c3e50; width: 100%; border: none; border-bottom: 2px solid #eee; padding: 0.5rem 0; outline: none; background: transparent; font-weight: bold;">
                        <span th:if="${#fields.hasErrors('title')}" th:errors="*{title}" class="error-message" style="color: #e74c3c; font-size: 0.9rem;"></span>
                    </div>

                    <!-- Descrizione -->
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <textarea id="description" th:field="*{description}" placeholder="Breve descrizione del piatto..." rows="3" style="width: 100%; border: 1px solid #eee; padding: 1rem; border-radius: 5px; font-size: 1.1rem; color: #7f8c8d; resize: vertical; font-family: inherit;"></textarea>
                        <span th:if="${#fields.hasErrors('description')}" th:errors="*{description}" class="error-message" style="color: #e74c3c; font-size: 0.9rem;"></span>
                    </div>
                    
                    <!-- Info Block -->
                    <div class="recipe-info-block" style="background-color: #f8f9fa; padding: 1.5rem; border-radius: 10px; border: 1px solid #eee;">
                        <!-- Row 1: Author & Date (Static/Hidden for new recipe) -->
                        <div style="display: flex; flex-direction: column; gap: 0.8rem; margin-bottom: 1rem; color: #555;">
                            <div>
                                <i class="fas fa-user" style="color: #e67e22; margin-right: 5px;"></i> 
                                <strong>Autore:</strong> <span th:text="${currentUser.name} + ' ' + ${currentUser.surname}">Mario Rossi</span>
                            </div>
                            <div>
                                <i class="far fa-calendar-alt" style="color: #e67e22; margin-right: 5px;"></i>
                                <strong>Data:</strong> <span th:text="${#temporals.format(#temporals.createNow(), 'dd/MM/yyyy')}">Oggi</span>
                            </div>
                        </div>

                        <hr style="border: 0; border-top: 1px solid #ddd; margin: 1rem 0;">

                        <!-- Row 2: Category, Time, Difficulty -->
                        <div style="display: flex; flex-direction: column; gap: 0.8rem; color: #555;">
                            <div class="form-group" style="margin-bottom: 0; display: flex; align-items: center;">
                                <i class="fas fa-tag" style="color: #e67e22; margin-right: 5px; width: 20px;"></i>
                                <strong style="margin-right: 10px;">Categoria:</strong>
                                <input type="text" id="category" th:field="*{category}" placeholder="Es. Primi Piatti" list="categories" required style="border: 1px solid #ddd; padding: 0.3rem; border-radius: 4px; flex: 1;">
                                <datalist id="categories">
                                    <option value="Antipasti">
                                    <option value="Primi Piatti">
                                    <option value="Secondi Piatti">
                                    <option value="Contorni">
                                    <option value="Dolci">
                                    <option value="Lievitati">
                                    <option value="Bevande">
                                </datalist>
                            </div>
                            <span th:if="${#fields.hasErrors('category')}" th:errors="*{category}" class="error-message" style="color: #e74c3c; font-size: 0.9rem; margin-left: 25px;"></span>

                            <div class="form-group" style="margin-bottom: 0; display: flex; align-items: center;">
                                <i class="far fa-clock" style="color: #e67e22; margin-right: 5px; width: 20px;"></i>
                                <strong style="margin-right: 10px;">Tempo:</strong>
                                <input type="number" id="prepTime" th:field="*{prepTime}" min="1" placeholder="30" required style="width: 80px; border: 1px solid #ddd; padding: 0.3rem; border-radius: 4px;"> <span style="margin-left: 5px;">min</span>
                            </div>
                            <span th:if="${#fields.hasErrors('prepTime')}" th:errors="*{prepTime}" class="error-message" style="color: #e74c3c; font-size: 0.9rem; margin-left: 25px;"></span>

                            <div class="form-group" style="margin-bottom: 0; display: flex; align-items: center;">
                                <i class="fas fa-signal" style="color: #e67e22; margin-right: 5px; width: 20px;"></i>
                                <strong style="margin-right: 10px;">Difficoltà:</strong>
                                <select id="difficulty" th:field="*{difficulty}" required style="border: 1px solid #ddd; padding: 0.3rem; border-radius: 4px; flex: 1;">
                                    <option value="1">Facile</option>
                                    <option value="2">Media</option>
                                    <option value="3">Difficile</option>
                                    <option value="4">Molto Difficile</option>
                                    <option value="5">Da Chef</option>
                                </select>
                            </div>
                            <span th:if="${#fields.hasErrors('difficulty')}" th:errors="*{difficulty}" class="error-message" style="color: #e74c3c; font-size: 0.9rem; margin-left: 25px;"></span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <button type="submit" class="btn" style="background-color: #2ecc71; color: white; padding: 0.8rem 2rem; border-radius: 5px; border: none; font-size: 1.1rem; cursor: pointer; width: 100%; transition: background-color 0.3s;">
                            <i class="fas fa-save"></i> Salva Ricetta
                        </button>
                    </div>
                </div>
            </div>

            <div class="recipe-detail-container">
                <!-- Colonna Sinistra: Ingredienti -->
                <aside class="ingredients-box">
                    <h3 style="margin-bottom: 1.5rem; color: #e67e22;"><i class="fas fa-shopping-basket"></i> Ingredienti</h3>
                    
                    <div id="ingredients-container">
                        <div class="form-row ingredient-row" style="margin-bottom: 10px; display: flex; gap: 5px;">
                            <input type="text" name="ingName" placeholder="Nome (Es. Farina)" required style="flex: 2; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="text" name="ingQuantity" placeholder="Quantità (Es. 200)" required style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="text" name="ingUnit" placeholder="Unità di misura (Es. g)" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <button type="button" class="btn btn-danger" onclick="removeRow(this)" style="padding: 0 10px; background-color: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="addIngredientRow()" style="margin-top: 10px; width: 100%; padding: 0.5rem; background-color: #e67e22; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        <i class="fas fa-plus"></i> Aggiungi Ingrediente
                    </button>
                </aside>

                <!-- Colonna Destra: Procedimento -->
                <section class="procedure-box">
                    <h3 style="margin-bottom: 1.5rem; color: #e67e22;"><i class="fas fa-list-ol"></i> Procedimento</h3>
                    <textarea id="procedure" th:field="*{procedure}" placeholder="Descrivi i passaggi passo dopo passo..." rows="15" style="width: 100%; border: 1px solid #ddd; padding: 1rem; border-radius: 5px; font-size: 1.1rem; line-height: 1.6; resize: vertical; font-family: inherit;"></textarea>
                    <span th:if="${#fields.hasErrors('procedure')}" th:errors="*{procedure}" class="error-message" style="color: #e74c3c; font-size: 0.9rem;"></span>
                </section>
            </div>

        </form>

    </main>

    <footer th:replace="~{fragments/base :: footer}"></footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const procedureTextarea = document.getElementById('procedure');
            if (procedureTextarea) {
                // Initialize with "1. " if empty on focus
                procedureTextarea.addEventListener('focus', function() {
                    if (!this.value.trim()) {
                        this.value = "1. ";
                    }
                });

                procedureTextarea.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const cursorPosition = this.selectionStart;
                        const currentContent = this.value;
                        const textBeforeCursor = currentContent.substring(0, cursorPosition);
                        const lines = textBeforeCursor.split('\n');
                        const currentLine = lines[lines.length - 1];
                        
                        // Check if current line starts with a number
                        const match = currentLine.match(/^(\d+)\./);
                        let nextNum = 1;
                        if (match) {
                            nextNum = parseInt(match[1]) + 1;
                        } else if (lines.length > 1) {
                             // Try to find the last number used
                             for (let i = lines.length - 1; i >= 0; i--) {
                                 const m = lines[i].match(/^(\d+)\./);
                                 if (m) {
                                     nextNum = parseInt(m[1]) + 1;
                                     break;
                                 }
                             }
                        }

                        const insertion = "\n" + nextNum + ". ";
                        const newContent = currentContent.substring(0, cursorPosition) + 
                                         insertion + 
                                         currentContent.substring(this.selectionEnd);
                        
                        this.value = newContent;
                        this.selectionStart = this.selectionEnd = cursorPosition + insertion.length;
                        
                        // Scroll to cursor
                        this.blur();
                        this.focus();
                    }
                });
            }
        });

        function addIngredientRow() {
            const container = document.getElementById('ingredients-container');
            const row = document.createElement('div');
            row.className = 'form-row ingredient-row';
            row.style.marginBottom = '10px';
            row.style.display = 'flex';
            row.style.gap = '5px';
            row.innerHTML = `
                <input type="text" name="ingName" placeholder="Es. Farina" required style="flex: 2; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                <input type="text" name="ingQuantity" placeholder="Quantità" required style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                <input type="text" name="ingUnit" placeholder="Unità di misura" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                <button type="button" class="btn btn-danger" onclick="removeRow(this)" style="padding: 0 10px; background-color: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(row);
        }
    
        function removeRow(btn) {
            const row = btn.closest('.ingredient-row');
            if(document.querySelectorAll('.ingredient-row').length > 1) {
                row.remove();
            } else {
                row.querySelectorAll('input').forEach(input => input.value = '');
            }
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('previewImg').style.display = 'block';
                    document.getElementById('placeholderContent').style.display = 'none';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
    </script>
</body>
</html>
