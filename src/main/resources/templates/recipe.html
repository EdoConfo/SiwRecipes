<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${recipe.title} + ' - SiwRecipes'">Dettaglio Ricetta</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Inline styles moved to styles.css for consistency and better validation handling -->
</head>
<body>

    <header th:replace="~{fragments/base :: header}"></header>

    <main class="container" style="max-width: 95%; margin: 2rem auto; padding: 0 1rem;">
        
        <div class="recipe-top-section">
            <!-- Immagine Ricetta (Sinistra) -->
            <div class="recipe-image-container">
                <img th:if="${recipe.image != null}" th:src="@{'/images/uploads/' + ${recipe.image}}" alt="Immagine Ricetta">
                <div th:if="${recipe.image == null}" class="recipe-image-placeholder">
                    <i class="fas fa-image fa-3x"></i>
                </div>
            </div>

            <!-- Intestazione Ricetta (Destra) -->
            <div class="recipe-info-container">
                <h1 th:text="${recipe.title}" class="recipe-header-title">Titolo Ricetta</h1>
                <p th:text="${recipe.description}" class="recipe-header-desc">Descrizione breve...</p>
                
                <!-- New Info Block -->
                <div class="recipe-info-block">
                    <!-- Row 1: Author & Date -->
                    <div style="display: flex; flex-direction: column; gap: 0.8rem; margin-bottom: 1rem;" class="recipe-info-item">
                        <div th:if="${recipe.author != null}">
                            <i class="fas fa-user" style="color: var(--primary-color); margin-right: 5px;"></i> 
                            <strong>Autore:</strong> <span th:text="${recipe.author.name} + ' ' + ${recipe.author.surname}">Mario Rossi</span>
                        </div>
                        <div th:if="${recipe.creationDate != null}">
                            <i class="far fa-calendar-alt" style="color: var(--primary-color); margin-right: 5px;"></i>
                            <strong>Data di inserimento:</strong> <span th:text="${#temporals.format(recipe.creationDate, 'dd/MM/yyyy')}">01/01/2024</span>
                        </div>
                    </div>

                    <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 1rem 0;">

                    <!-- Row 2: Category, Time, Difficulty -->
                    <div style="display: flex; flex-direction: column; gap: 0.8rem;" class="recipe-info-item">
                        <div th:if="${recipe.category != null}">
                            <i class="fas fa-tag" style="color: var(--primary-color); margin-right: 5px;"></i>
                            <strong>Categoria:</strong> <span th:text="${recipe.category}">Categoria</span>
                        </div>
                        <div>
                            <i class="far fa-clock" style="color: var(--primary-color); margin-right: 5px;"></i>
                            <strong>Tempo:</strong> <span th:text="${recipe.prepTime} + ' min'">45 min</span>
                        </div>
                        <div>
                            <i class="fas fa-signal" style="color: var(--primary-color); margin-right: 5px;"></i>
                            <strong>Difficoltà:</strong>
                            <span th:if="${recipe.difficulty == 1}">Facile</span>
                            <span th:if="${recipe.difficulty == 2}">Media</span>
                            <span th:if="${recipe.difficulty == 3}">Difficile</span>
                            <span th:if="${recipe.difficulty > 3}">Molto Difficile</span>
                        </div>
                    </div>
                </div>

                <!-- Pulsanti Modifica/Elimina per l'autore o Admin -->
                <div th:if="${isAuthor or isAdmin}" class="action-btn-group">
                    <a th:if="${isAuthor}" th:href="@{'/recipe/' + ${recipe.id} + '/edit'}" class="btn-warning">
                        <i class="fas fa-edit"></i> Modifica
                    </a>
                    <a th:href="@{'/recipe/' + ${recipe.id} + '/delete'}" class="btn-danger" onclick="return confirm('Sei sicuro di voler eliminare questa ricetta?');">
                        <i class="fas fa-trash-alt"></i> Elimina
                    </a>
                </div>
            </div>
        </div>

        <div class="recipe-detail-container">
            
            <!-- Colonna Sinistra: Ingredienti -->
            <aside class="ingredients-box">
                <h3><i class="fas fa-shopping-basket"></i> Ingredienti</h3>
                
                <ul class="ingredients-list" th:if="${recipe.ingredients != null && !recipe.ingredients.isEmpty()}">
                    <li th:each="ingredient : ${recipe.ingredients}">
                        <span th:text="${ingredient.name}">Farina</span>
                        <span>
                            <span th:text="${ingredient.quantity}">200</span>
                            <span th:text="${ingredient.unitOfMeasure}">g</span>
                        </span>
                    </li>
                </ul>
                
                <p th:if="${recipe.ingredients == null || recipe.ingredients.isEmpty()}">Nessun ingrediente specificato.</p>
            </aside>

            <!-- Colonna Destra: Procedimento -->
            <section class="procedure-box">
                <h3><i class="fas fa-list-ol"></i> Procedimento</h3>
                <div class="procedure-text" th:text="${recipe.procedure}">
                    Qui apparirà il testo del procedimento della ricetta...
                </div>
            </section>

        </div>

        <!-- Sezione Recensioni -->
        <div class="reviews-section" style="margin-top: 3rem;">
            <h2 class="reviews-section-title">Recensioni</h2>
            
            <!-- Lista Recensioni (Griglia) -->
            <div th:if="${recipe.reviews != null && !recipe.reviews.isEmpty()}" class="reviews-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
                <div th:each="singleReview : ${recipe.reviews}" th:id="'review-' + ${singleReview.id}" class="review-card">
                    
                    <!-- Visualizzazione Normale -->
                    <div th:if="${editingReviewId != singleReview.id}">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                            <div>
                                <strong th:text="${singleReview.title}" class="review-card-title">Titolo</strong>
                                <span class="review-card-meta">
                                    da <span th:text="${singleReview.author.name}" style="font-weight: 600;">Autore</span>
                                </span>
                            </div>
                            <div style="color: #f1c40f; white-space: nowrap;">
                                <i th:each="i : ${#numbers.sequence(1, 5)}" 
                                   th:class="${i <= singleReview.rating} ? 'fas fa-star' : 'far fa-star'"></i>
                            </div>
                        </div>
                        
                        <p th:text="${singleReview.text}" class="review-card-text">Testo recensione...</p>
                        
                        <div class="review-card-footer">
                            <div style="font-size: 0.8rem;">
                                <i class="far fa-calendar-alt"></i> <span th:text="${#temporals.format(singleReview.creationDate, 'dd/MM/yyyy')}">Data</span>
                            </div>
                            
                            <!-- Pulsanti Modifica/Elimina per l'autore o Admin -->
                            <div th:if="${currentUser != null && (singleReview.author.id == currentUser.id || isAdmin)}" style="display: flex; gap: 0.5rem;">
                                <a th:if="${singleReview.author.id == currentUser.id}" th:href="@{'/review/' + ${singleReview.id} + '/edit'}" title="Modifica" style="color: #3498db; font-size: 0.9rem;"><i class="fas fa-edit"></i></a>
                                <a th:href="@{'/review/' + ${singleReview.id} + '/delete'}" title="Elimina" onclick="return confirm('Sei sicuro di voler eliminare questa recensione?')" style="color: #e74c3c; font-size: 0.9rem;"><i class="fas fa-trash-alt"></i></a>
                            </div>
                        </div>
                    </div>

                    <!-- Form di Modifica Inline -->
                    <div th:if="${editingReviewId == singleReview.id}">
                        <h4 style="margin-bottom: 1rem; color: var(--primary-color);">Modifica Recensione</h4>
                        <form th:action="@{'/review/' + ${singleReview.id} + '/update'}" method="POST" th:object="${review}">
                            
                            <div style="margin-bottom: 0.5rem;">
                                <label style="display: block; font-size: 0.9rem; font-weight: bold; color: var(--text-color);">Valutazione:</label>
                                <div class="rating-input" style="font-size: 0.9rem;">
                                    <input type="radio" th:id="'edit-star5-' + ${singleReview.id}" name="rating" value="5" th:field="*{rating}" /><label th:for="'edit-star5-' + ${singleReview.id}"><i class="fas fa-star"></i></label>
                                    <input type="radio" th:id="'edit-star4-' + ${singleReview.id}" name="rating" value="4" th:field="*{rating}" /><label th:for="'edit-star4-' + ${singleReview.id}"><i class="fas fa-star"></i></label>
                                    <input type="radio" th:id="'edit-star3-' + ${singleReview.id}" name="rating" value="3" th:field="*{rating}" /><label th:for="'edit-star3-' + ${singleReview.id}"><i class="fas fa-star"></i></label>
                                    <input type="radio" th:id="'edit-star2-' + ${singleReview.id}" name="rating" value="2" th:field="*{rating}" /><label th:for="'edit-star2-' + ${singleReview.id}"><i class="fas fa-star"></i></label>
                                    <input type="radio" th:id="'edit-star1-' + ${singleReview.id}" name="rating" value="1" th:field="*{rating}" /><label th:for="'edit-star1-' + ${singleReview.id}"><i class="fas fa-star"></i></label>
                                </div>
                                <span th:if="${#fields.hasErrors('rating')}" th:errors="*{rating}" style="color: #e74c3c; font-size: 0.8rem;"></span>
                            </div>

                            <div style="margin-bottom: 0.5rem;">
                                <input type="text" th:field="*{title}" placeholder="Titolo" required class="card-input">
                                <span th:if="${#fields.hasErrors('title')}" th:errors="*{title}" style="color: #e74c3c; font-size: 0.8rem;"></span>
                            </div>

                            <div style="margin-bottom: 0.5rem;">
                                <textarea th:field="*{text}" placeholder="Testo" rows="3" class="card-input" style="resize: vertical;"></textarea>
                                <span th:if="${#fields.hasErrors('text')}" th:errors="*{text}" style="color: #e74c3c; font-size: 0.8rem;"></span>
                            </div>

                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button type="submit" class="btn" style="background-color: #2ecc71; color: white; padding: 0.5rem 1rem; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9rem;">Salva</button>
                                <a th:href="@{'/recipe/' + ${recipe.id}}" class="btn" style="background-color: #95a5a6; color: white; padding: 0.5rem 1rem; border-radius: 5px; text-decoration: none; font-size: 0.9rem;">Annulla</a>
                            </div>
                        </form>
                    </div>

                </div>
            </div>
            
            <div th:if="${recipe.reviews == null || recipe.reviews.isEmpty()}" style="color: var(--meta-color); font-style: italic; margin-top: 1rem;">
                <p th:if="${currentUser != null}" style="margin: 0;">Nessuna recensione ancora. Sii il primo a recensire!</p>
                <p th:if="${currentUser == null}" style="margin: 0;">Nessuna recensione ancora. <a th:href="@{/login}" style="color: #e67e22; text-decoration: underline; font-weight: bold;">Accedi</a> o <a th:href="@{/register}" style="color: #e67e22; text-decoration: underline; font-weight: bold;">Registrati</a> per scriverne una.</p>
            </div>

            <!-- Form Nuova Recensione -->
            <div th:if="${currentUser != null && !isAuthor}" class="new-review-form">
                <h3>Lascia una recensione</h3>
                <form th:action="@{'/recipe/' + ${recipe.id} + '/review'}" method="POST" th:object="${newReview}">
                    
                    <div th:if="${#fields.hasGlobalErrors()}" class="error-message" style="color: #e74c3c; margin-bottom: 1rem;">
                        <p th:each="err : ${#fields.globalErrors()}" th:text="${err}">Errore</p>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: var(--text-color);">Valutazione:</label>
                        <div class="rating-input">
                            <input type="radio" id="star5" name="rating" value="5" th:field="*{rating}" required /><label for="star5" title="5 stelle"><i class="fas fa-star"></i></label>
                            <input type="radio" id="star4" name="rating" value="4" th:field="*{rating}" required /><label for="star4" title="4 stelle"><i class="fas fa-star"></i></label>
                            <input type="radio" id="star3" name="rating" value="3" th:field="*{rating}" required /><label for="star3" title="3 stelle"><i class="fas fa-star"></i></label>
                            <input type="radio" id="star2" name="rating" value="2" th:field="*{rating}" required /><label for="star2" title="2 stelle"><i class="fas fa-star"></i></label>
                            <input type="radio" id="star1" name="rating" value="1" th:field="*{rating}" required /><label for="star1" title="1 stella"><i class="fas fa-star"></i></label>
                        </div>
                        <span th:if="${#fields.hasErrors('rating')}" th:errors="*{rating}" style="color: #e74c3c; font-size: 0.9rem;"></span>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <input type="text" th:field="*{title}" placeholder="Titolo della recensione" required class="card-input">
                        <span th:if="${#fields.hasErrors('title')}" th:errors="*{title}" style="color: #e74c3c; font-size: 0.9rem;"></span>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <textarea th:field="*{text}" placeholder="Scrivi la tua opinione..." rows="4" class="card-input" style="resize: vertical;"></textarea>
                        <span th:if="${#fields.hasErrors('text')}" th:errors="*{text}" style="color: #e74c3c; font-size: 0.9rem;"></span>
                    </div>

                    <button type="submit" class="btn" style="background-color: #e67e22; color: white; padding: 0.8rem 2rem; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Invia Recensione</button>
                </form>
            </div>
        </div>

    </main>

    <footer th:replace="~{fragments/base :: footer}"></footer>

</body>
</html>
